hgts_clear_jump_settings = {
    remove_global_flag = hgts_jump_allow_allies
    remove_global_flag = hgts_jump_allow_neutral
}

#Fix for Void Dweller origin + tankbound giving too many pops
void_dweller_home_planet_setup = {
	optimize_memory
	set_planet_flag = habitat_level_2
	set_timed_planet_flag = {
		flag = ignore_ai_building_limitations
		days = 1
	}
	owner = {
		save_event_target_as = void_dweller_owner
		give_technology = {
			tech = tech_habitat_1
			message = no
		}
		add_research_option = tech_habitat_2
	}
	solar_system = {
		random_system_planet = {
			limit = { has_planet_flag = habitat_1_planet }
			save_event_target_as = habitat_1_planet
			solar_system = {
				spawn_orbital_effect = {
					TYPE = major
					HABITAT_OWNER = event_target:void_dweller_owner
					TARGET_PLANET = event_target:habitat_1_planet
				}
			}
		}
		random_system_planet = {
			limit = { has_planet_flag = habitat_2_planet }
			save_event_target_as = habitat_2_planet
			solar_system = {
				spawn_orbital_effect = {
					TYPE = major
					HABITAT_OWNER = event_target:void_dweller_owner
					TARGET_PLANET = event_target:habitat_2_planet
				}
			}
		}
		random_system_planet = {
			limit = { has_planet_flag = habitat_3_planet }
			save_event_target_as = habitat_3_planet
			solar_system = {
				spawn_orbital_effect = {
					TYPE = major
					HABITAT_OWNER = event_target:void_dweller_owner
					TARGET_PLANET = event_target:habitat_3_planet
				}
			}
		}
		if = {
			limit = {
				event_target:void_dweller_owner = {
					is_lithoid_empire = yes
				}
			}
			random_system_planet = {
				limit = {
					has_deposit = no
					is_colonizable = no
				}
				add_deposit = d_minerals_4
				set_planet_flag = mining_planet
			}
		}
		every_system_planet = {
			limit = { has_planet_flag = mining_planet }
			create_mining_station = { owner = event_target:void_dweller_owner }
		}
		# Change starting pre-scripted ideal into inhabitable worlds
		# First pre-sripted is a research system
		closest_system = {
			limit = { has_star_flag = neighbor_t1_first_colony }
			set_star_flag = ideal_habitat_t1
			max_steps = 3
			random_system_planet = {
				limit = {
					is_colonizable = yes
					is_colony = no
					has_planet_flag = prescripted_ideal
				}
				change_pc = pc_frozen
				set_deposit = d_engineering_5
			}
			while = {
				count = 3
				random_system_planet = {
					limit = {
						is_star = no
						is_colonizable = no
						has_deposit = no
						has_anomaly = no
					}
					random_list = {
						5 = { set_deposit = d_physics_2 }
						5 = { set_deposit = d_society_2 }
						5 = { set_deposit = d_engineering_2 }
						1 = { set_deposit = d_physics_3 }
						1 = { set_deposit = d_society_3 }
						1 = { set_deposit = d_engineering_3 }
					}
				}
			}
		}
		# Second pre-sripted is a resource system
		closest_system = {
			limit = { has_star_flag = neighbor_t2_second_colony }
			set_star_flag = ideal_habitat_t2
			max_steps = 6
			random_system_planet = {
				limit = {
					is_colonizable = yes
					is_colony = no
					has_planet_flag = prescripted_ideal
				}
				remove_planet_flag = prescripted_ideal
				change_pc = pc_molten
				set_deposit = d_alloys_3
				add_deposit = d_minerals_5
			}
			while = {
				count = 3
				random_system_planet = {
					limit = {
						is_star = no
						has_deposit = no
						has_anomaly = no
					}
					random_list = {
						5 = { set_deposit = d_minerals_2 }
						5 = { set_deposit = d_energy_2 }
						1 = { set_deposit = d_minerals_3 }
						1 = { set_deposit = d_energy_3 }
					}
				}
			}
		}
	}
	event_target:habitat_1_planet = {
		set_planet_flag = habitat@PREV
	}
	owner = {
		if = {
			limit = {
				OR = {
					AND = {
						is_lithoid_empire = no
						is_mechanical_species = no
					}
					is_catalytic_empire = yes
					country_uses_bio_ships = yes
				}
			}
			root.solar_system.starbase = {
				remove_starbase_building = {
					slot = 1
				}
				set_starbase_building = {
					slot = 1
					building = hydroponics_bay
				}
			}
		}
		if = {
			limit = {
				has_valid_civic = civic_private_healthcare_corporate
			}
			give_technology = { message = no tech = tech_frontier_health }
			add_research_option = tech_subdermal_stimulation
		}
	}

	if = { # First we generate pops for empires without strange pop starts
		limit = {
			owner = {
				NOR = {
					is_eager_explorer_empire = yes
					has_valid_civic = civic_machine_servitor
					has_valid_civic = civic_machine_assimilator
					has_valid_civic = civic_hive_bodysnatcher
				}
			}
		}
		create_pop_group = {
			size = 2800
			species = owner_main_species
		}
	}
	else_if = { # Then we generate pops for eager explorer empires
		limit = {
			owner = {
				is_eager_explorer_empire = yes
			}
		}
		if = { #if they have a secondary species spawn that now
			limit = {
				owner = {
					OR = {
						has_valid_civic = civic_machine_servitor
						has_valid_civic = civic_machine_assimilator
						has_valid_civic = civic_hive_bodysnatcher
					}
				}
			}
			generate_civic_secondary_pops = yes
		}
		while = {
			limit = { pop_amount < 1800 }
			create_pop_group = {
				species = owner_main_species
			}
		}
	}
	else = { # Now we should only have secondary species generating empires left in this chain so spawn the rest
		generate_civic_secondary_pops = yes
		while = {
			limit = { pop_amount < 2800 }
			create_pop_group = {
				species = owner_main_species
			}
		}
	}
	if = {
		limit = {
			owner = {
				is_hive_empire = yes
			}
		}
		create_pop_group = {
			size = 500
			species = owner_main_species
		}
	}

	# Civilians
    if = {
        limit = { 
            owner = {
                NOR = {
                    is_tankbound_empire = yes
                }
            }
        }
	    while = {
		    count = @civilians_counter
		    create_pop_group = {
		    	size = @civilians_gamestart
		    	species = owner_main_species
                category = civilian
		    }
	    }
    }

	if = {
		limit = {
			owner = {
				has_valid_civic = civic_permanent_employment
			}
		}
		while = {
			count = 4
			weighted_random_owned_pop_group = {
				limit = {
					is_pop_category = worker
					is_robotic_species = no
				}
				modify_species = {
					species = this
					add_trait = trait_zombie
					add_traits_at_start_of_list = yes
				}
				if = {
					limit = {
						has_trait = trait_syncretic_proles
					}
					modify_species = {
						species = this
						remove_trait = trait_syncretic_proles
					}
				}
			}
		}
	}

	set_planet_entity = {
		entity = "habitat_phase_03_entity"
		graphical_culture = owner
	}

	inline_script = "game_start/rural_districts_initializer"

	add_building = building_hab_major_capital

	add_district_and_planet_size_if_needed_effect_amount = {
		amount = 2
		district = district_hab_housing
	}

	if = {
		limit = {
			owner = {
				OR = {
					is_regular_empire = yes
					has_valid_civic = civic_machine_servitor
					has_valid_civic = civic_machine_obsessional_directive
				}
			}
		}
		add_zone = {
			district = district_hab_housing
			zone = zone_industrial
			zone_slot = 2
		}
		add_building = {
			building = building_factory_1
			zone = zone_industrial
		}
	}
	else = {
		add_zone = {
			district = district_hab_housing
			zone = zone_foundry
			zone_slot = 2
		}
	}

	add_district_and_planet_size_if_needed_effect_amount = {
		amount = 1
		district = district_hab_science
	}

	add_zone = {
		district = district_hab_housing
		zone = zone_habitat_research_unity
		zone_slot = 1
	}

	# Shipsets
	inline_script = "game_start/shipsets"

	# Species
	inline_script = "game_start/species_lithoids"
	inline_script = "game_start/species_hive_void_dwellers"
	inline_script = "game_start/species_machine_void_dwellers"
	inline_script = "game_start/species_individual_machine_void_dwellers"
	inline_script = "game_start/species_subspecies" ## Set subspecies flags

	## Ethic
	inline_script = "game_start/ethic_spiritualist"
	inline_script = "game_start/ethic_materialist"
	inline_script = "game_start/ethic_pacifist"
	inline_script = "game_start/ethic_militarist"
	inline_script = "game_start/ethic_egalitarian"
	inline_script = "game_start/ethic_authoritarian"
	inline_script = "game_start/ethic_xenophile"
	inline_script = "game_start/ethic_xenophobe"

	##Civics
	inline_script = "game_start/civics"

	# Apply rural districts depending on variable count
	inline_script = "game_start/rural_districts_placement"

	set_planet_size = 6

	give_starting_resources_effect = yes
}